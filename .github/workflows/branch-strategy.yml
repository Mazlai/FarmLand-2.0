name: Branch Strategy Validation

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - develop
      - main
      - 'release/**'

permissions:
  contents: read

jobs:
  validate-branch-strategy:
    name: Validate Branch Strategy
    runs-on: ubuntu-latest
    steps:
      - name: Check branch naming rules
        run: |
          SOURCE="${{ github.head_ref }}"
          TARGET="${{ github.base_ref }}"

          echo "Source branch : $SOURCE"
          echo "Target branch : $TARGET"

          if [[ "$TARGET" == "develop" ]]; then
            if [[ ! "$SOURCE" == feature/* ]]; then
              echo "ERROR: Only branches starting with 'feature/' can be merged into 'develop'."
              echo "       Current source branch: $SOURCE"
              exit 1
            fi
            echo "OK: feature/* -> develop"

          elif [[ "$TARGET" == "main" ]]; then
            if [[ ! "$SOURCE" == release/* ]]; then
              echo "ERROR: Only branches starting with 'release/' can be merged into 'main'."
              echo "       Current source branch: $SOURCE"
              exit 1
            fi
            echo "OK: release/* -> main"

          elif [[ "$TARGET" == release/* ]]; then
            if [[ "$SOURCE" != "develop" && ! "$SOURCE" == hotfix/* ]]; then
              echo "ERROR: Only 'develop' or branches starting with 'hotfix/' can be merged into 'release/*'."
              echo "       Current source branch: $SOURCE"
              exit 1
            fi
            echo "OK: develop/hotfix/* -> release/*"
          fi
